<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchestrator Conversational AI - Modern Test Client</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --background-color: #0f172a;
            --surface-color: #1e293b;
            --surface-light: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-color: #475569;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--background-color) 0%, #1e1b4b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease-out;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.2rem;
            font-weight: 300;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--surface-color);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease-out;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
            color: white;
        }

        .card-icon.primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        }

        .card-icon.success {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }

        .card-icon.warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
        }

        .card-icon.error {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
        }

        .card-icon.secondary {
            background: linear-gradient(135deg, var(--secondary-color), #7c3aed);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .status {
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            font-weight: 600;
            text-align: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .status.connected {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        .status.disconnected {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }

        .status.processing {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
            animation: pulse 2s infinite;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn:not(:disabled):hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }

        .upload-text {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--surface-light);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            animation: slideInRight 0.5s ease-out;
        }

        .file-item:hover {
            transform: translateX(5px);
            background: var(--border-color);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .file-icon.pdf {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .file-icon.txt {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .file-icon.docx {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        .file-icon.md {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .file-details h4 {
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .file-details p {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        .audio-visualizer {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, var(--surface-color), var(--surface-light));
            border-radius: 15px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .audio-bar {
            position: absolute;
            bottom: 0;
            width: 6px;
            background: linear-gradient(to top, var(--primary-color), var(--secondary-color));
            border-radius: 3px 3px 0 0;
            transition: height 0.1s ease;
        }

        .recording-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 20px;
            height: 20px;
            background: var(--error-color);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .messages {
            height: 400px;
            overflow-y: auto;
            border-radius: 15px;
            padding: 20px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .messages::-webkit-scrollbar {
            width: 8px;
        }

        .messages::-webkit-scrollbar-track {
            background: var(--surface-light);
            border-radius: 4px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
            background: var(--surface-light);
            transition: all 0.3s ease;
            animation: slideInLeft 0.5s ease-out;
        }

        .message:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .message.transcript {
            border-left-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
        }

        .message.rag-response {
            border-left-color: var(--secondary-color);
            background: rgba(139, 92, 246, 0.1);
        }

        .message.audio {
            border-left-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
        }

        .message.error {
            border-left-color: var(--error-color);
            background: rgba(239, 68, 68, 0.1);
        }

        .message.state {
            border-left-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .message-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-content {
            color: var(--text-secondary);
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: var(--surface-color);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease-out;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .config-section {
            margin: 30px 0;
            padding: 25px;
            background: var(--surface-color);
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }

        .config-section h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            background: var(--surface-light);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            background: var(--surface-light);
            color: var(--text-primary);
            transition: all 0.3s ease;
            resize: vertical;
            min-height: 80px;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .documents-list {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 10px;
            padding: 15px;
            background: var(--surface-light);
            border: 1px solid var(--border-color);
            margin-top: 20px;
        }

        .documents-list::-webkit-scrollbar {
            width: 8px;
        }

        .documents-list::-webkit-scrollbar-track {
            background: var(--surface-color);
            border-radius: 4px;
        }

        .documents-list::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .document-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--surface-color);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            animation: slideInRight 0.5s ease-out;
        }

        .document-item:hover {
            transform: translateX(5px);
            background: var(--border-color);
        }

        .document-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .document-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
        }

        .document-icon.pdf {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .document-icon.txt {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .document-icon.docx {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        .document-icon.md {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .document-details h4 {
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 3px;
            font-weight: 600;
        }

        .document-details p {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin: 0;
        }

        .document-actions {
            display: flex;
            gap: 8px;
        }

        .query-results {
            margin-top: 20px;
            padding: 20px;
            background: var(--surface-light);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            min-height: 100px;
        }

        .query-result {
            padding: 15px;
            background: var(--surface-color);
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            animation: slideInLeft 0.5s ease-out;
        }

        .query-result h4 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .query-result p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .query-metadata {
            font-size: 0.8rem;
            color: var(--text-muted);
            background: var(--surface-light);
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 0.9rem;
        }

        .text-error {
            color: var(--error-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .transcription-container {
            margin-top: 20px;
        }

        .transcription-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--surface-light);
            border-radius: 10px;
        }

        .transcription-status {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            margin-left: auto;
        }

        .transcription-display {
            height: 200px;
            overflow-y: auto;
            border-radius: 10px;
            padding: 15px;
            background: var(--surface-light);
            border: 1px solid var(--border-color);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .transcription-display::-webkit-scrollbar {
            width: 8px;
        }

        .transcription-display::-webkit-scrollbar-track {
            background: var(--surface-color);
            border-radius: 4px;
        }

        .transcription-display::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .transcription-text {
            color: var(--text-primary);
            margin-bottom: 8px;
            padding: 8px 12px;
            background: var(--surface-color);
            border-radius: 6px;
            border-left: 3px solid var(--success-color);
            animation: slideInLeft 0.3s ease-out;
        }

        .transcription-text.interim {
            border-left-color: var(--warning-color);
            opacity: 0.7;
            font-style: italic;
        }

        .transcription-text.final {
            border-left-color: var(--success-color);
            font-weight: 500;
        }

        .transcription-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .empty-transcription {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-transcription i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .empty-transcription p {
            font-size: 0.9rem;
        }

        .ai-response-container {
            margin-top: 20px;
        }

        .ai-response-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--surface-light);
            border-radius: 10px;
        }

        .audio-status {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            margin-left: auto;
        }

        /* Debug Panel Styles */
        .debug-panel {
            margin-bottom: 20px;
            border: 2px solid var(--warning-color);
        }

        .debug-controls {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .debug-content {
            margin-top: 15px;
        }

        .debug-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--surface-light);
            border-radius: 10px;
        }

        .debug-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--surface);
            border-radius: 8px;
            border-left: 3px solid var(--warning-color);
        }

        .stat-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
        }

        .debug-logs {
            height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--surface);
            padding: 15px;
        }

        .debug-log-entry {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            border-left: 3px solid var(--primary-color);
        }

        .debug-log-entry.error {
            background: rgba(220, 53, 69, 0.1);
            border-left-color: var(--danger-color);
            color: var(--danger-color);
        }

        .debug-log-entry.warning {
            background: rgba(255, 193, 7, 0.1);
            border-left-color: var(--warning-color);
            color: var(--warning-color);
        }

        .debug-log-entry.info {
            background: rgba(13, 110, 253, 0.1);
            border-left-color: var(--info-color);
            color: var(--info-color);
        }

        .debug-log-entry.success {
            background: rgba(25, 135, 84, 0.1);
            border-left-color: var(--success-color);
            color: var(--success-color);
        }

        .debug-log-timestamp {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-right: 10px;
        }

        .debug-log-message {
            font-weight: 500;
        }

        .debug-log-details {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 4px;
            white-space: pre-wrap;
        }

        .empty-debug {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }

        .empty-debug i {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .empty-debug p {
            font-size: 0.9rem;
        }

        .ai-response-display {
            height: 200px;
            overflow-y: auto;
            border-radius: 10px;
            padding: 15px;
            background: var(--surface-light);
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .ai-response-display::-webkit-scrollbar {
            width: 8px;
        }

        .ai-response-display::-webkit-scrollbar-track {
            background: var(--surface-color);
            border-radius: 4px;
        }

        .ai-response-display::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 4px;
        }

        .ai-response-text {
            color: var(--text-primary);
            margin-bottom: 12px;
            padding: 12px 15px;
            background: var(--surface-color);
            border-radius: 8px;
            border-left: 4px solid var(--secondary-color);
            animation: slideInRight 0.3s ease-out;
        }

        .ai-response-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 6px;
            background: var(--surface-light);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .empty-response {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-response i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .empty-response p {
            font-size: 0.9rem;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--surface-light);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 4px;
            transition: width 0.3s ease;
            animation: shimmer 2s infinite;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }

        .toast.success {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }

        .toast.error {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
        }

        .toast.warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> Orchestrator AI</h1>
            <p>Advanced Conversational AI with Document Processing</p>
        </div>

        <div id="status" class="status disconnected">
            <i class="fas fa-circle"></i> Disconnected
        </div>

        <div class="controls">
            <button id="connectBtn" class="btn btn-primary">
                <i class="fas fa-plug"></i> Connect
            </button>
            <button id="disconnectBtn" class="btn btn-danger" disabled>
                <i class="fas fa-unlink"></i> Disconnect
            </button>
            <button id="startRecordingBtn" class="btn btn-success" disabled>
                <i class="fas fa-microphone"></i> Start Recording
            </button>
            <button id="stopRecordingBtn" class="btn btn-warning" disabled>
                <i class="fas fa-stop"></i> Stop Recording
            </button>
            <button id="clearMessagesBtn" class="btn btn-primary">
                <i class="fas fa-trash"></i> Clear Messages
            </button>
        </div>

        <!-- Debug Panel -->
        <div class="card debug-panel" id="debugPanel">
            <div class="card-header">
                <div class="card-icon warning">
                    <i class="fas fa-bug"></i>
                </div>
                <h3 class="card-title">Debug Console</h3>
                <div class="debug-controls">
                    <button id="toggleDebugBtn" class="btn btn-small btn-warning">
                        <i class="fas fa-eye"></i> Toggle Debug
                    </button>
                    <button id="clearDebugBtn" class="btn btn-small btn-danger">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                    <button id="exportDebugBtn" class="btn btn-small btn-primary">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="debug-content" id="debugContent">
                <div class="debug-stats">
                    <div class="debug-stat">
                        <span class="stat-label">Connection State:</span>
                        <span class="stat-value" id="connectionState">Disconnected</span>
                    </div>
                    <div class="debug-stat">
                        <span class="stat-label">Attempts:</span>
                        <span class="stat-value" id="connectionAttempts">0</span>
                    </div>
                    <div class="debug-stat">
                        <span class="stat-label">Messages:</span>
                        <span class="stat-value" id="totalMessages">0</span>
                    </div>
                    <div class="debug-stat">
                        <span class="stat-label">Errors:</span>
                        <span class="stat-value" id="totalErrors">0</span>
                    </div>
                </div>
                
                <div class="debug-logs" id="debugLogs">
                    <div class="empty-debug">
                        <i class="fas fa-terminal"></i>
                        <p>Debug logs will appear here...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon primary">
                        <i class="fas fa-file-upload"></i>
                    </div>
                    <h3 class="card-title">Document Upload</h3>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">Drop files here or click to upload</div>
                    <div class="upload-subtext">Supports PDF, TXT, DOCX, MD files (Max 10MB)</div>
                    <input type="file" id="fileInput" multiple accept=".pdf,.txt,.docx,.md" style="display: none;">
                </div>

                <div class="file-list" id="fileList"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon success">
                        <i class="fas fa-microphone"></i>
                    </div>
                    <h3 class="card-title">Audio Visualization</h3>
                </div>
                
                <div class="audio-visualizer" id="audioVisualizer">
                    <div id="recordingIndicator" class="recording-indicator hidden"></div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon primary">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h3 class="card-title">Live Transcription</h3>
                </div>
                
                <div class="transcription-container">
                    <div class="transcription-controls">
                        <button id="clearTranscriptionBtn" class="btn btn-small btn-warning">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                        <button id="copyTranscriptionBtn" class="btn btn-small btn-primary">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <span class="transcription-status" id="transcriptionStatus">Ready</span>
                    </div>
                    
                    <div class="transcription-display" id="transcriptionDisplay">
                        <div class="empty-transcription">
                            <i class="fas fa-microphone-slash"></i>
                            <p>Start recording to see live transcription...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon secondary">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h3 class="card-title">AI Response</h3>
                </div>
                
                <div class="ai-response-container">
                    <div class="ai-response-controls">
                        <button id="playAudioBtn" class="btn btn-small btn-success" disabled>
                            <i class="fas fa-play"></i> Play Audio
                        </button>
                        <button id="stopAudioBtn" class="btn btn-small btn-danger" disabled>
                            <i class="fas fa-stop"></i> Stop
                        </button>
                        <span class="audio-status" id="audioStatus">No Audio</span>
                    </div>
                    
                    <div class="ai-response-display" id="aiResponseDisplay">
                        <div class="empty-response">
                            <i class="fas fa-robot"></i>
                            <p>AI responses will appear here...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon warning">
                        <i class="fas fa-list"></i>
                    </div>
                    <h3 class="card-title">Document Management</h3>
                </div>
                
                <div class="controls">
                    <button id="listDocumentsBtn" class="btn btn-primary">
                        <i class="fas fa-list"></i> List Documents
                    </button>
                    <button id="refreshDocumentsBtn" class="btn btn-success">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button id="resetSystemBtn" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i> Reset System
                    </button>
                </div>

                <div class="documents-list" id="documentsList"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon secondary">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3 class="card-title">Document Query</h3>
                </div>
                
                <div class="form-group">
                    <label for="queryInput">Query Text:</label>
                    <textarea id="queryInput" rows="3" placeholder="Enter your question about the documents..."></textarea>
                </div>
                
                <div class="controls">
                    <button id="queryDocumentsBtn" class="btn btn-primary">
                        <i class="fas fa-search"></i> Query Documents
                    </button>
                    <button id="clearQueryBtn" class="btn btn-warning">
                        <i class="fas fa-eraser"></i> Clear
                    </button>
                </div>

                <div class="query-results" id="queryResults"></div>
            </div>
        </div>

        <div class="config-section">
            <h3><i class="fas fa-cog"></i> Configuration</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="serverUrl">Server URL:</label>
                    <input type="text" id="serverUrl" value="ws://localhost:8004/ws/conversation">
                </div>
                <div class="form-group">
                    <label for="languageCode">Language:</label>
                    <select id="languageCode">
                        <option value="ar-EG">Arabic (Egypt)</option>
                        <option value="en-US">English (US)</option>
                        <option value="fr-FR">French</option>
                        <option value="de-DE">German</option>
                        <option value="es-ES">Spanish</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="voiceGender">Voice Gender:</label>
                    <select id="voiceGender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="auto">Auto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="speakingRate">Speaking Rate:</label>
                    <input type="range" id="speakingRate" min="0.5" max="2.0" step="0.1" value="1.0">
                    <span id="speakingRateValue">1.0x</span>
                </div>
            </div>
            
            <div class="controls">
                <button id="healthCheckBtn" class="btn btn-success">
                    <i class="fas fa-heartbeat"></i> Health Check
                </button>
                <button id="systemStatsBtn" class="btn btn-primary">
                    <i class="fas fa-chart-bar"></i> System Stats
                </button>
            </div>
        </div>

        <div class="messages" id="messages"></div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="messagesCount">0</div>
                <div class="stat-label">Messages</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="audioChunksCount">0</div>
                <div class="stat-label">Audio Chunks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="filesUploaded">0</div>
                <div class="stat-label">Files Uploaded</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="sessionId">-</div>
                <div class="stat-label">Session ID</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="connectionTime">-</div>
                <div class="stat-label">Connection Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="processingTime">-</div>
                <div class="stat-label">Avg Processing</div>
            </div>
        </div>
    </div>

    <script>
        class ModernOrchestratorClient {
            constructor() {
                this.ws = null;
                this.mediaRecorder = null;
                this.audioStream = null;
                this.isRecording = false;
                this.isConnected = false;
                this.sessionId = null;
                this.connectionStartTime = null;
                this.messageCount = 0;
                this.audioChunkCount = 0;
                this.filesUploaded = 0;
                this.processingTimes = [];
                this.uploadedFiles = [];
                this.fullTranscription = '';
                this.currentInterimTranscription = '';
                this.aiResponse = '';
                this.audioQueue = [];
                this.isPlayingAudio = false;
                this.audioContext = null;
                this.audioBuffer = null;
                
                // Debug and logging
                this.debugMode = true;
                this.debugLogEntries = [];
                this.connectionAttempts = 0;
                this.lastError = null;
                this.connectionState = 'disconnected';
                this.messageQueue = [];
                this.performanceMetrics = {
                    connectionTime: 0,
                    firstMessageTime: 0,
                    lastMessageTime: 0,
                    totalMessages: 0,
                    errors: 0
                };
                
                // Recording guards
                this.recordingStartInProgress = false;
                
                this.initializeElements();
                this.setupEventListeners();
                this.setupAudioVisualizer();
                this.setupFileUpload();
            }
            
            initializeElements() {
                this.statusEl = document.getElementById('status');
                this.messagesEl = document.getElementById('messages');
                this.connectBtn = document.getElementById('connectBtn');
                this.disconnectBtn = document.getElementById('disconnectBtn');
                this.startRecordingBtn = document.getElementById('startRecordingBtn');
                this.stopRecordingBtn = document.getElementById('stopRecordingBtn');
                this.clearMessagesBtn = document.getElementById('clearMessagesBtn');
                this.serverUrlEl = document.getElementById('serverUrl');
                this.languageCodeEl = document.getElementById('languageCode');
                this.voiceGenderEl = document.getElementById('voiceGender');
                this.speakingRateEl = document.getElementById('speakingRate');
                this.speakingRateValueEl = document.getElementById('speakingRateValue');
                this.audioVisualizerEl = document.getElementById('audioVisualizer');
                this.recordingIndicatorEl = document.getElementById('recordingIndicator');
                this.uploadAreaEl = document.getElementById('uploadArea');
                this.fileInputEl = document.getElementById('fileInput');
                this.fileListEl = document.getElementById('fileList');
                
                // Document management elements
                this.listDocumentsBtn = document.getElementById('listDocumentsBtn');
                this.refreshDocumentsBtn = document.getElementById('refreshDocumentsBtn');
                this.resetSystemBtn = document.getElementById('resetSystemBtn');
                this.documentsListEl = document.getElementById('documentsList');
                this.queryInputEl = document.getElementById('queryInput');
                this.queryDocumentsBtn = document.getElementById('queryDocumentsBtn');
                this.clearQueryBtn = document.getElementById('clearQueryBtn');
                this.queryResultsEl = document.getElementById('queryResults');
                this.healthCheckBtn = document.getElementById('healthCheckBtn');
                this.systemStatsBtn = document.getElementById('systemStatsBtn');
                
                // Transcription and AI response elements
                this.clearTranscriptionBtn = document.getElementById('clearTranscriptionBtn');
                this.copyTranscriptionBtn = document.getElementById('copyTranscriptionBtn');
                this.transcriptionStatusEl = document.getElementById('transcriptionStatus');
                this.transcriptionDisplayEl = document.getElementById('transcriptionDisplay');
                this.aiResponseDisplayEl = document.getElementById('aiResponseDisplay');
                this.playAudioBtn = document.getElementById('playAudioBtn');
                this.stopAudioBtn = document.getElementById('stopAudioBtn');
                this.audioStatusEl = document.getElementById('audioStatus');
                
                // Debug elements
                this.debugPanel = document.getElementById('debugPanel');
                this.debugContent = document.getElementById('debugContent');
                this.debugLogs = document.getElementById('debugLogs');
                this.toggleDebugBtn = document.getElementById('toggleDebugBtn');
                this.clearDebugBtn = document.getElementById('clearDebugBtn');
                this.exportDebugBtn = document.getElementById('exportDebugBtn');
                this.connectionStateEl = document.getElementById('connectionState');
                this.connectionAttemptsEl = document.getElementById('connectionAttempts');
                this.totalMessagesEl = document.getElementById('totalMessages');
                this.totalErrorsEl = document.getElementById('totalErrors');
                
                // Stats elements
                this.messagesCountEl = document.getElementById('messagesCount');
                this.audioChunksCountEl = document.getElementById('audioChunksCount');
                this.filesUploadedEl = document.getElementById('filesUploaded');
                this.sessionIdEl = document.getElementById('sessionId');
                this.connectionTimeEl = document.getElementById('connectionTime');
                this.processingTimeEl = document.getElementById('processingTime');
            }
            
            setupEventListeners() {
                this.connectBtn.addEventListener('click', () => this.connect());
                this.disconnectBtn.addEventListener('click', () => this.disconnect());
                this.startRecordingBtn.addEventListener('click', () => this.startRecording());
                this.stopRecordingBtn.addEventListener('click', () => this.stopRecording());
                this.clearMessagesBtn.addEventListener('click', () => this.clearMessages());
                this.speakingRateEl.addEventListener('input', (e) => {
                    this.speakingRateValueEl.textContent = e.target.value + 'x';
                });
                
                // Document management event listeners
                this.listDocumentsBtn.addEventListener('click', () => this.listDocuments());
                this.refreshDocumentsBtn.addEventListener('click', () => this.listDocuments());
                this.resetSystemBtn.addEventListener('click', () => this.resetSystem());
                this.queryDocumentsBtn.addEventListener('click', () => this.queryDocuments());
                this.clearQueryBtn.addEventListener('click', () => this.clearQuery());
                this.healthCheckBtn.addEventListener('click', () => this.getSystemHealth());
                this.systemStatsBtn.addEventListener('click', () => this.getSystemStats());
                
                // Transcription controls
                this.clearTranscriptionBtn.addEventListener('click', () => this.clearTranscription());
                this.copyTranscriptionBtn.addEventListener('click', () => this.copyTranscription());
                
                // Audio controls
                this.playAudioBtn.addEventListener('click', () => this.playAudio());
                this.stopAudioBtn.addEventListener('click', () => this.stopAudio());
                
                // Debug controls
                this.toggleDebugBtn.addEventListener('click', () => this.toggleDebugMode());
                this.clearDebugBtn.addEventListener('click', () => this.clearDebugLogs());
                this.exportDebugBtn.addEventListener('click', () => this.exportDebugLogs());
            }
            
            setupFileUpload() {
                this.uploadAreaEl.addEventListener('click', () => this.fileInputEl.click());
                this.uploadAreaEl.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.uploadAreaEl.classList.add('dragover');
                });
                this.uploadAreaEl.addEventListener('dragleave', () => {
                    this.uploadAreaEl.classList.remove('dragover');
                });
                this.uploadAreaEl.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.uploadAreaEl.classList.remove('dragover');
                    this.handleFiles(e.dataTransfer.files);
                });
                this.fileInputEl.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                });
            }
            
            handleFiles(files) {
                Array.from(files).forEach(file => {
                    if (this.validateFile(file)) {
                        this.uploadFile(file);
                    }
                });
            }
            
            validateFile(file) {
                const allowedTypes = ['application/pdf', 'text/plain', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/markdown'];
                const maxSize = 10 * 1024 * 1024; // 10MB
                
                if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|txt|docx|md)$/i)) {
                    this.showToast('Invalid file type. Please upload PDF, TXT, DOCX, or MD files.', 'error');
                    return false;
                }
                
                if (file.size > maxSize) {
                    this.showToast('File too large. Maximum size is 10MB.', 'error');
                    return false;
                }
                
                return true;
            }
            
            async uploadFile(file) {
                const fileId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const fileItem = {
                    id: fileId,
                    file: file,
                    status: 'uploading'
                };
                
                this.uploadedFiles.push(fileItem);
                this.addFileToList(fileItem);
                
                try {
                    // Upload to RAG system
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const response = await fetch('https://arabic-rag-system-g7emhxfjaq-uc.a.run.app/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        fileItem.status = 'uploaded';
                        fileItem.documentId = result.document_id;
                        this.updateFileStatus(fileId, 'uploaded');
                        this.filesUploaded++;
                        this.updateStats();
                        this.showToast(`File "${file.name}" uploaded successfully!`, 'success');
                        this.addMessage('system', `File uploaded: ${file.name}`, {
                            documentId: result.document_id,
                            chunksProcessed: result.chunks_processed,
                            processingTime: result.processing_time_ms,
                            fileSize: this.formatFileSize(file.size),
                            fileType: file.type
                        });
                        
                        // Refresh documents list
                        this.listDocuments();
                    } else {
                        const error = await response.json();
                        fileItem.status = 'error';
                        this.updateFileStatus(fileId, 'error');
                        this.showToast(`Upload failed: ${error.detail}`, 'error');
                        this.addMessage('error', `Upload failed: ${error.detail}`, {
                            fileName: file.name,
                            status: response.status
                        });
                    }
                } catch (error) {
                    fileItem.status = 'error';
                    this.updateFileStatus(fileId, 'error');
                    this.showToast(`Upload error: ${error.message}`, 'error');
                    this.addMessage('error', `Upload error: ${error.message}`, {
                        fileName: file.name
                    });
                }
            }
            
            addFileToList(fileItem) {
                const fileEl = document.createElement('div');
                fileEl.className = 'file-item';
                fileEl.id = `file-${fileItem.id}`;
                
                const fileIcon = this.getFileIcon(fileItem.file.name);
                const fileExtension = fileItem.file.name.split('.').pop().toLowerCase();
                
                fileEl.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon ${fileExtension}">
                            <i class="${fileIcon}"></i>
                        </div>
                        <div class="file-details">
                            <h4>${fileItem.file.name}</h4>
                            <p>${this.formatFileSize(fileItem.file.size)}</p>
                        </div>
                    </div>
                    <div class="file-actions">
                        ${fileItem.status === 'uploading' ? 
                            '<div class="loading"></div>' : 
                            '<button class="btn btn-small btn-danger" onclick="client.removeFile(\'' + fileItem.id + '\')"><i class="fas fa-trash"></i></button>'
                        }
                    </div>
                `;
                
                this.fileListEl.appendChild(fileEl);
            }
            
            updateFileStatus(fileId, status) {
                const fileEl = document.getElementById(`file-${fileId}`);
                if (fileEl) {
                    const actionsEl = fileEl.querySelector('.file-actions');
                    if (status === 'uploaded') {
                        actionsEl.innerHTML = '<button class="btn btn-small btn-danger" onclick="client.removeFile(\'' + fileId + '\')"><i class="fas fa-trash"></i></button>';
                    } else if (status === 'error') {
                        actionsEl.innerHTML = '<span class="text-error"><i class="fas fa-exclamation-triangle"></i> Error</span>';
                    }
                }
            }
            
            removeFile(fileId) {
                const fileIndex = this.uploadedFiles.findIndex(f => f.id === fileId);
                if (fileIndex > -1) {
                    this.uploadedFiles.splice(fileIndex, 1);
                    const fileEl = document.getElementById(`file-${fileId}`);
                    if (fileEl) {
                        fileEl.remove();
                    }
                    this.filesUploaded--;
                    this.updateStats();
                    this.showToast('File removed', 'warning');
                }
            }
            
            getFileIcon(filename) {
                const extension = filename.split('.').pop().toLowerCase();
                const icons = {
                    'pdf': 'fas fa-file-pdf',
                    'txt': 'fas fa-file-alt',
                    'docx': 'fas fa-file-word',
                    'md': 'fas fa-file-code'
                };
                return icons[extension] || 'fas fa-file';
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            setupAudioVisualizer() {
                for (let i = 0; i < 60; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'audio-bar';
                    bar.style.left = `${i * 10}px`;
                    bar.style.height = '0px';
                    this.audioVisualizerEl.appendChild(bar);
                }
            }
            
            async connect() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.addMessage('warning', 'Already connected to WebSocket');
                    this.addDebugLog('warning', 'Connection attempt while already connected', {
                        readyState: this.ws.readyState,
                        url: this.ws.url
                    });
                    return;
                }

                this.connectionAttempts++;
                this.updateDebugStats();
                
                try {
                    const url = this.serverUrlEl.value;
                    this.addMessage('info', 'Connecting to Orchestrator WebSocket...');
                    this.addDebugLog('info', 'Starting WebSocket connection', {
                        attempt: this.connectionAttempts,
                        url: url,
                        timestamp: new Date().toISOString()
                    });
                    
                    this.connectionState = 'connecting';
                    this.updateConnectionStatus('connecting');
                    
                    const startTime = performance.now();
                    this.ws = new WebSocket(url);
                    
                    this.ws.onopen = (event) => {
                        const connectionTime = performance.now() - startTime;
                        this.performanceMetrics.connectionTime = connectionTime;
                        
                        this.isConnected = true;
                        this.connectionStartTime = new Date();
                        this.updateStatus('Connected', 'connected');
                        this.updateButtons();
                        
                        this.addMessage('system', 'Connected to Orchestrator', {
                            serverUrl: url,
                            timestamp: new Date().toISOString()
                        });
                        
                        this.addDebugLog('success', 'WebSocket connection established', {
                            connectionTime: `${connectionTime.toFixed(2)}ms`,
                            readyState: this.ws.readyState,
                            protocol: this.ws.protocol,
                            extensions: this.ws.extensions,
                            event: {
                                type: event.type,
                                timeStamp: event.timeStamp
                            }
                        });
                        
                        this.connectionState = 'connected';
                        this.updateConnectionStatus('connected');
                        this.showToast('Connected successfully!', 'success');
                        
                        // Auto-start recording when WebSocket is connected
                        if (!this.isRecording) {
                            this.startRecording();
                        }
                    };
                    
                    this.ws.onmessage = (event) => {
                        this.performanceMetrics.totalMessages++;
                        this.performanceMetrics.lastMessageTime = performance.now();
                        this.updateDebugStats();
                        
                        // Parse message content for debugging
                        let messageContent = null;
                        try {
                            if (typeof event.data === 'string') {
                                messageContent = JSON.parse(event.data);
                            }
                        } catch (e) {
                            messageContent = event.data;
                        }
                        
                        this.addDebugLog('info', 'WebSocket message received', {
                            dataType: typeof event.data,
                            dataSize: event.data ? event.data.length : 0,
                            messageType: messageContent?.type || 'unknown',
                            messageContent: messageContent,
                            timestamp: new Date().toISOString()
                        });
                        
                        this.handleMessage(event);
                    };
                    
                    this.ws.onclose = (event) => {
                        this.addMessage('system', 'Disconnected from Orchestrator');
                        this.addDebugLog('warning', 'WebSocket connection closed', {
                            code: event.code,
                            reason: event.reason,
                            wasClean: event.wasClean,
                            timestamp: new Date().toISOString()
                        });
                        
                        this.isConnected = false;
                        this.updateStatus('Disconnected', 'disconnected');
                        this.updateButtons();
                        this.stopRecording();
                        
                        this.connectionState = 'disconnected';
                        this.updateConnectionStatus('disconnected');
                        this.showToast('Connection lost', 'warning');
                    };
                    
                    this.ws.onerror = (error) => {
                        this.performanceMetrics.errors++;
                        this.updateDebugStats();
                        
                        this.addMessage('error', `WebSocket Error: ${error}`);
                        this.addDebugLog('error', 'WebSocket error occurred', {
                            error: error.toString(),
                            readyState: this.ws ? this.ws.readyState : 'unknown',
                            timestamp: new Date().toISOString()
                        });
                        
                        this.lastError = error;
                        this.connectionState = 'error';
                        this.updateConnectionStatus('error');
                        this.showToast('Connection error', 'error');
                    };
                    
                } catch (error) {
                    this.performanceMetrics.errors++;
                    this.updateDebugStats();
                    
                    this.addMessage('error', `Connection Error: ${error.message}`);
                    this.addDebugLog('error', 'WebSocket connection failed', {
                        error: error.message,
                        stack: error.stack,
                        timestamp: new Date().toISOString()
                    });
                    
                    this.lastError = error;
                    this.connectionState = 'error';
                    this.updateConnectionStatus('error');
                    this.showToast('Connection failed', 'error');
                }
            }
            
            disconnect() {
                if (this.ws) {
                    this.stopRecording();
                    this.ws.close();
                }
            }
            
            async startRecording() {
                if (!this.isConnected) {
                    this.addMessage('error', 'Not connected to WebSocket');
                    this.addDebugLog('error', 'Recording attempt without WebSocket connection');
                    return;
                }
                if (this.isRecording || this.recordingStartInProgress) {
                    return;
                }

                try {
                    this.recordingStartInProgress = true;
                    this.addMessage('info', 'Starting audio recording...');
                    this.addDebugLog('info', 'Starting audio recording', {
                        isConnected: this.isConnected,
                        wsReadyState: this.ws ? this.ws.readyState : 'unknown',
                        timestamp: new Date().toISOString()
                    });

                    this.audioStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });

                    // If server expects LINEAR16, stream raw PCM; else use MediaRecorder (Opus)
                    if ((this.serverAudioEncoding || '') === 'LINEAR16') {
                        await this.startPcmStream();
                    } else {
                        // Pick the first supported MIME type at runtime to avoid NotSupportedError
                        const preferredTypes = ['audio/ogg;codecs=opus', 'audio/webm;codecs=opus', 'audio/webm', 'audio/ogg'];
                        let chosenType = '';
                        if (window.MediaRecorder && typeof MediaRecorder.isTypeSupported === 'function') {
                            for (const t of preferredTypes) {
                                try { if (MediaRecorder.isTypeSupported(t)) { chosenType = t; break; } } catch (e) {}
                            }
                        }
                        if (!chosenType) { this.addDebugLog('warning', 'No preferred MIME type supported; browser default'); }
                        const options = chosenType ? { mimeType: chosenType, audioBitsPerSecond: 128000 } : { audioBitsPerSecond: 128000 };
                        this.mediaRecorder = new MediaRecorder(this.audioStream, options);
                        this.mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0 && this.isConnected) {
                                this.addDebugLog('info', 'Audio chunk recorded', { chunkSize: event.data.size, wsReadyState: this.ws ? this.ws.readyState : 'unknown', timestamp: new Date().toISOString() });
                                this.sendAudioChunk(event.data);
                            }
                        };
                        this.mediaRecorder.start(100);
                    }
                    this.isRecording = true;
                    this.updateButtons();
                    this.recordingIndicatorEl.classList.remove('hidden');
                    this.transcriptionStatusEl.textContent = 'Recording...';
                    
                    this.addMessage('system', 'Started recording audio', {
                        sampleRate: 16000,
                        channels: 1
                    });
                    
                    const debugInfo = {
                        encoding: (this.serverAudioEncoding || (this.mediaRecorder && this.mediaRecorder.mimeType) || 'unknown'),
                        method: ((this.serverAudioEncoding || '') === 'LINEAR16') ? 'PCM' : 'MediaRecorder',
                        timestamp: new Date().toISOString()
                    };
                    if (this.mediaRecorder && typeof this.mediaRecorder.state !== 'undefined') {
                        debugInfo.state = this.mediaRecorder.state;
                    }
                    this.addDebugLog('success', 'Audio recording started successfully', debugInfo);
                    
                    this.showToast('Recording started', 'success');
                    this.recordingStartInProgress = false;
                    
                } catch (error) {
                    this.addMessage('error', `Recording Error: ${error.message}`);
                    this.addDebugLog('error', 'Failed to start audio recording', {
                        error: error.message,
                        stack: error.stack,
                        timestamp: new Date().toISOString()
                    });
                    this.showToast('Recording failed', 'error');
                    this.recordingStartInProgress = false;
                }
            }
            
            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    try { this.mediaRecorder.stop(); } catch (e) {}
                }
                if ((this.serverAudioEncoding || '') === 'LINEAR16') {
                    this.stopPcmStream();
                }
                this.isRecording = false;
                this.recordingStartInProgress = false;

                if (this.audioStream) {
                    this.audioStream.getTracks().forEach(track => track.stop());
                    this.audioStream = null;
                }
                
                this.updateButtons();
                this.recordingIndicatorEl.classList.add('hidden');
                this.transcriptionStatusEl.textContent = 'Processing...';
                
                if (this.isConnected) {
                    this.addMessage('system', 'Stopped recording audio');
                    this.ws.send(JSON.stringify({type: 'audio_end'}));
                    this.showToast('Recording stopped', 'warning');
                }
            }

            async startPcmStream() {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                this.audioContext = new AudioCtx({ sampleRate: 48000 });
                this.sourceNode = this.audioContext.createMediaStreamSource(this.audioStream);
                const bufferSize = 4096;
                this.scriptNode = this.audioContext.createScriptProcessor(bufferSize, 1, 1);
                const inputRate = this.audioContext.sampleRate;
                const targetRate = 16000;
                this.scriptNode.onaudioprocess = (e) => {
                    if (!this.isRecording || !this.isConnected || this.ws.readyState !== WebSocket.OPEN) return;
                    const input = e.inputBuffer.getChannelData(0);
                    const down = this.downsampleBuffer(input, inputRate, targetRate);
                    if (!down || down.length === 0) return;
                    const pcm16 = this.floatTo16BitPCM(down);
                    try { this.ws.send(pcm16.buffer); this.audioChunkCount++; this.updateStats(); } catch (err) { this.addDebugLog('error', 'Failed to send PCM', { error: String(err) }); }
                };
                this.sourceNode.connect(this.scriptNode);
                this.scriptNode.connect(this.audioContext.destination);
            }

            stopPcmStream() {
                try {
                    if (this.scriptNode) { this.scriptNode.disconnect(); this.scriptNode.onaudioprocess = null; this.scriptNode = null; }
                    if (this.sourceNode) { this.sourceNode.disconnect(); this.sourceNode = null; }
                    if (this.audioContext) { this.audioContext.close(); this.audioContext = null; }
                } catch (e) {}
            }

            downsampleBuffer(buffer, sampleRate, outSampleRate) {
                if (outSampleRate === sampleRate) return buffer;
                const ratio = sampleRate / outSampleRate;
                const newLen = Math.round(buffer.length / ratio);
                const result = new Float32Array(newLen);
                let offsetResult = 0;
                let offsetBuffer = 0;
                while (offsetResult < result.length) {
                    const nextOffsetBuffer = Math.round((offsetResult + 1) * ratio);
                    let accum = 0, count = 0;
                    for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) { accum += buffer[i]; count++; }
                    result[offsetResult] = accum / count;
                    offsetResult++;
                    offsetBuffer = nextOffsetBuffer;
                }
                return result;
            }

            floatTo16BitPCM(float32Array) {
                const buffer = new ArrayBuffer(float32Array.length * 2);
                const view = new DataView(buffer);
                let offset = 0;
                for (let i = 0; i < float32Array.length; i++, offset += 2) {
                    let s = Math.max(-1, Math.min(1, float32Array[i]));
                    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                }
                return new Uint8Array(buffer);
            }
            
            sendAudioChunk(audioData) {
                if (this.isConnected && this.ws.readyState === WebSocket.OPEN) {
                    this.addDebugLog('info', 'Sending audio chunk', {
                        chunkSize: audioData.size,
                        chunkType: audioData.type,
                        wsReadyState: this.ws.readyState,
                        timestamp: new Date().toISOString()
                    });
                    
                    this.ws.send(audioData);
                    this.audioChunkCount++;
                    this.updateStats();
                    this.updateAudioVisualizer();
                } else {
                    this.addDebugLog('warning', 'Cannot send audio chunk - WebSocket not ready', {
                        isConnected: this.isConnected,
                        wsReadyState: this.ws ? this.ws.readyState : 'unknown',
                        timestamp: new Date().toISOString()
                    });
                }
            }
            
            handleMessage(event) {
                try {
                    const data = JSON.parse(event.data);
                    this.messageCount++;
                    this.updateStats();
                    
                    const startTime = Date.now();
                    
                    switch (data.type) {
                        case 'ready':
                            this.sessionId = data.session_id;
                            // Save server audio config for capture pipeline selection
                            this.serverAudioConfig = data.audio_config || {};
                            this.serverAudioEncoding = (this.serverAudioConfig.encoding || '').toUpperCase();
                            this.addMessage('system', `Session ready: ${data.session_id}`, {
                                audioConfig: data.audio_config,
                                timestamp: new Date().toISOString()
                            });
                            break;
                            
                        case 'transcript':
                            this.handleTranscriptMessage(data);
                            this.addMessage('transcript', `Transcript: ${data.text}`, {
                                isFinal: data.is_final,
                                confidence: data.confidence,
                                language: data.language_code
                            });
                            break;
                            
                        case 'rag_response':
                            const processingTime = Date.now() - startTime;
                            this.processingTimes.push(processingTime);
                            this.handleAIResponse(data);
                            this.addMessage('rag-response', `RAG Response: ${data.text}`, {
                                processingTime: processingTime,
                                modelUsed: data.model_used,
                                sources: data.sources
                            });
                            break;
                            
                        case 'audio_chunk_tts':
                            this.handleAudioChunk(data);
                            this.addMessage('audio', `Audio chunk received: ${data.audio_data ? data.audio_data.length : 0} bytes`, {
                                chunkIndex: data.chunk_index,
                                isFinalChunk: data.is_final_chunk,
                                voiceUsed: data.voice_used
                            });
                            break;
                            
                        case 'state_update':
                            this.addMessage('state', `State: ${data.previous_state}  ${data.state}`, {
                                timestamp: new Date().toISOString()
                            });
                            this.updateStatus(`State: ${data.state}`, 'processing');
                            // Backend-driven recording control
                            if (data.state === 'listening' && !this.isRecording) {
                                this.startRecording();
                            }
                            if ((data.state === 'processing' || data.state === 'speaking' || data.state === 'idle') && this.isRecording) {
                                this.stopRecording();
                            }
                            break;
                            
                        case 'complete':
                            this.addMessage('system', 'Conversation completed', {
                                totalProcessingTime: this.processingTimes.reduce((a, b) => a + b, 0),
                                averageProcessingTime: this.processingTimes.reduce((a, b) => a + b, 0) / this.processingTimes.length
                            });
                            this.updateStatus('Connected', 'connected');
                            break;
                            
                        case 'error':
                            this.addMessage('error', `Error: ${data.error_code} - ${data.detail}`, {
                                solutions: data.solutions
                            });
                            this.showToast(`Error: ${data.error_code}`, 'error');
                            break;
                            
                        default:
                            this.addMessage('system', `Unknown message type: ${data.type}`);
                    }
                    
                } catch (error) {
                    this.addMessage('audio', `Received binary data: ${event.data.length} bytes`);
                }
            }
            
            addMessage(type, content, metadata = {}) {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${type}`;
                
                const headerEl = document.createElement('div');
                headerEl.className = 'message-header';
                headerEl.innerHTML = `${this.getMessageTypeIcon(type)} ${this.getMessageTypeLabel(type)}`;
                
                const contentEl = document.createElement('div');
                contentEl.className = 'message-content';
                contentEl.textContent = content;
                
                const timeEl = document.createElement('div');
                timeEl.className = 'message-time';
                timeEl.textContent = new Date().toLocaleTimeString();
                
                messageEl.appendChild(headerEl);
                messageEl.appendChild(contentEl);
                messageEl.appendChild(timeEl);
                
                if (Object.keys(metadata).length > 0) {
                    const metadataEl = document.createElement('div');
                    metadataEl.className = 'message-content';
                    metadataEl.style.fontSize = '0.8rem';
                    metadataEl.style.color = 'var(--text-muted)';
                    metadataEl.style.marginTop = '5px';
                    metadataEl.textContent = JSON.stringify(metadata, null, 2);
                    messageEl.appendChild(metadataEl);
                }
                
                this.messagesEl.appendChild(messageEl);
                this.messagesEl.scrollTop = this.messagesEl.scrollHeight;
            }
            
            getMessageTypeIcon(type) {
                const icons = {
                    'system': 'fas fa-cog',
                    'transcript': 'fas fa-microphone',
                    'rag-response': 'fas fa-brain',
                    'audio': 'fas fa-volume-up',
                    'state': 'fas fa-exchange-alt',
                    'error': 'fas fa-exclamation-triangle'
                };
                return `<i class="${icons[type] || 'fas fa-info-circle'}"></i>`;
            }
            
            getMessageTypeLabel(type) {
                const labels = {
                    'system': 'System',
                    'transcript': 'Transcript',
                    'rag-response': 'AI Response',
                    'audio': 'Audio',
                    'state': 'State Update',
                    'error': 'Error'
                };
                return labels[type] || type;
            }
            
            updateStatus(text, className) {
                const icon = className === 'connected' ? 'fas fa-check-circle' : 
                           className === 'disconnected' ? 'fas fa-times-circle' : 
                           'fas fa-spinner fa-spin';
                this.statusEl.innerHTML = `<i class="${icon}"></i> ${text}`;
                this.statusEl.className = `status ${className}`;
            }
            
            updateButtons() {
                this.connectBtn.disabled = this.isConnected;
                this.disconnectBtn.disabled = !this.isConnected;
                this.startRecordingBtn.disabled = !this.isConnected || this.isRecording;
                this.stopRecordingBtn.disabled = !this.isConnected || !this.isRecording;
            }
            
            updateStats() {
                this.messagesCountEl.textContent = this.messageCount;
                this.audioChunksCountEl.textContent = this.audioChunkCount;
                this.filesUploadedEl.textContent = this.filesUploaded;
                this.sessionIdEl.textContent = this.sessionId ? this.sessionId.substring(0, 8) + '...' : '-';
                
                if (this.connectionStartTime) {
                    const duration = Math.floor((new Date() - this.connectionStartTime) / 1000);
                    this.connectionTimeEl.textContent = `${duration}s`;
                }
                
                if (this.processingTimes.length > 0) {
                    const avgTime = this.processingTimes.reduce((a, b) => a + b, 0) / this.processingTimes.length;
                    this.processingTimeEl.textContent = `${Math.round(avgTime)}ms`;
                }
            }
            
            updateAudioVisualizer() {
                const bars = this.audioVisualizerEl.querySelectorAll('.audio-bar');
                bars.forEach(bar => {
                    const height = Math.random() * 100 + 10;
                    bar.style.height = `${height}px`;
                });
            }
            
            clearMessages() {
                this.messagesEl.innerHTML = '';
                this.messageCount = 0;
                this.audioChunkCount = 0;
                this.processingTimes = [];
                this.updateStats();
                this.showToast('Messages cleared', 'warning');
            }
            
            showToast(message, type) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
            
            // Document Management Methods
            
            async listDocuments() {
                try {
                    this.listDocumentsBtn.innerHTML = '<div class="loading"></div> Loading...';
                    this.listDocumentsBtn.disabled = true;
                    
                    const response = await fetch('https://arabic-rag-system-g7emhxfjaq-uc.a.run.app/documents');
                    if (response.ok) {
                        const data = await response.json();
                        this.displayDocuments(data.documents);
                        this.addMessage('system', `Listed ${data.total_count} documents`, {
                            totalCount: data.total_count,
                            documents: data.documents.length
                        });
                    } else {
                        const error = await response.json();
                        this.showToast(`Failed to list documents: ${error.detail}`, 'error');
                        this.addMessage('error', `Failed to list documents: ${error.detail}`);
                    }
                } catch (error) {
                    this.showToast(`Error listing documents: ${error.message}`, 'error');
                    this.addMessage('error', `Error listing documents: ${error.message}`);
                } finally {
                    this.listDocumentsBtn.innerHTML = '<i class="fas fa-list"></i> List Documents';
                    this.listDocumentsBtn.disabled = false;
                }
            }
            
            displayDocuments(documents) {
                this.documentsListEl.innerHTML = '';
                
                if (documents.length === 0) {
                    this.documentsListEl.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h3>No Documents</h3>
                            <p>Upload some documents to get started</p>
                        </div>
                    `;
                    return;
                }
                
                documents.forEach(doc => {
                    const docEl = document.createElement('div');
                    docEl.className = 'document-item';
                    
                    const fileExtension = doc.filename.split('.').pop().toLowerCase();
                    const fileIcon = this.getFileIcon(doc.filename);
                    
                    docEl.innerHTML = `
                        <div class="document-info">
                            <div class="document-icon ${fileExtension}">
                                <i class="${fileIcon}"></i>
                            </div>
                            <div class="document-details">
                                <h4>${doc.filename}</h4>
                                <p>ID: ${doc.file_id} | Chunks: ${doc.chunk_count} | Uploaded: ${new Date(doc.upload_time).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="document-actions">
                            <button class="btn btn-small btn-warning" onclick="client.updateDocument('${doc.file_id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="client.deleteDocument('${doc.file_id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    this.documentsListEl.appendChild(docEl);
                });
            }
            
            async deleteDocument(documentId) {
                if (!confirm('Are you sure you want to delete this document?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`https://arabic-rag-system-g7emhxfjaq-uc.a.run.app/documents/${documentId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.showToast(`Document deleted successfully`, 'success');
                        this.addMessage('system', `Document deleted: ${documentId}`, {
                            chunksDeleted: result.chunks_deleted,
                            status: result.status
                        });
                        this.listDocuments(); // Refresh list
                    } else {
                        const error = await response.json();
                        this.showToast(`Failed to delete document: ${error.detail}`, 'error');
                        this.addMessage('error', `Failed to delete document: ${error.detail}`);
                    }
                } catch (error) {
                    this.showToast(`Error deleting document: ${error.message}`, 'error');
                    this.addMessage('error', `Error deleting document: ${error.message}`);
                }
            }
            
            async updateDocument(documentId) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.pdf,.txt,.docx,.md';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (!this.validateFile(file)) return;
                    
                    try {
                        const formData = new FormData();
                        formData.append('file', file);
                        
                        const response = await fetch(`https://arabic-rag-system-g7emhxfjaq-uc.a.run.app/documents/${documentId}`, {
                            method: 'PUT',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            this.showToast(`Document updated successfully`, 'success');
                            this.addMessage('system', `Document updated: ${file.name}`, {
                                documentId: documentId,
                                chunksProcessed: result.chunks_processed,
                                processingTime: result.processing_time_ms
                            });
                            this.listDocuments(); // Refresh list
                        } else {
                            const error = await response.json();
                            this.showToast(`Failed to update document: ${error.detail}`, 'error');
                            this.addMessage('error', `Failed to update document: ${error.detail}`);
                        }
                    } catch (error) {
                        this.showToast(`Error updating document: ${error.message}`, 'error');
                        this.addMessage('error', `Error updating document: ${error.message}`);
                    }
                };
                input.click();
            }
            
            async resetSystem() {
                if (!confirm('Are you sure you want to reset the entire system? This will delete ALL documents and cannot be undone!')) {
                    return;
                }
                
                try {
                    this.resetSystemBtn.innerHTML = '<div class="loading"></div> Resetting...';
                    this.resetSystemBtn.disabled = true;
                    
                    const response = await fetch('https://arabic-rag-system-g7emhxfjaq-uc.a.run.app/reset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ remove_originals: true })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.showToast(`System reset successfully`, 'success');
                        this.addMessage('system', `System reset completed`, {
                            status: result.status,
                            documentsRemoved: result.documents_removed,
                            chunksRemoved: result.chunks_removed
                        });
                        this.listDocuments(); // Refresh list
                        this.filesUploaded = 0;
                        this.updateStats();
                    } else {
                        const error = await response.json();
                        this.showToast(`Failed to reset system: ${error.detail}`, 'error');
                        this.addMessage('error', `Failed to reset system: ${error.detail}`);
                    }
                } catch (error) {
                    this.showToast(`Error resetting system: ${error.message}`, 'error');
                    this.addMessage('error', `Error resetting system: ${error.message}`);
                } finally {
                    this.resetSystemBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Reset System';
                    this.resetSystemBtn.disabled = false;
                }
            }
            
            async queryDocuments() {
                const query = this.queryInputEl.value.trim();
                if (!query) {
                    this.showToast('Please enter a query', 'warning');
                    return;
                }
                
                try {
                    this.queryDocumentsBtn.innerHTML = '<div class="loading"></div> Querying...';
                    this.queryDocumentsBtn.disabled = true;
                    
                    const response = await fetch('https://arabic-rag-system-g7emhxfjaq-uc.a.run.app/query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            query: query,
                            session_id: this.sessionId
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.displayQueryResult(result);
                        this.addMessage('rag-response', `Query: ${query}`, {
                            response: result.response,
                            documentIds: result.document_ids,
                            processingTime: result.processing_time_ms,
                            modelUsed: result.model_used
                        });
                    } else {
                        const error = await response.json();
                        this.showToast(`Query failed: ${error.detail}`, 'error');
                        this.addMessage('error', `Query failed: ${error.detail}`);
                    }
                } catch (error) {
                    this.showToast(`Error querying documents: ${error.message}`, 'error');
                    this.addMessage('error', `Error querying documents: ${error.message}`);
                } finally {
                    this.queryDocumentsBtn.innerHTML = '<i class="fas fa-search"></i> Query Documents';
                    this.queryDocumentsBtn.disabled = false;
                }
            }
            
            displayQueryResult(result) {
                this.queryResultsEl.innerHTML = `
                    <div class="query-result">
                        <h4><i class="fas fa-brain"></i> AI Response</h4>
                        <p>${result.response}</p>
                        <div class="query-metadata">
                            <strong>Processing Time:</strong> ${result.processing_time_ms}ms | 
                            <strong>Model:</strong> ${result.model_used} | 
                            <strong>Sources:</strong> ${result.document_ids.length} documents
                        </div>
                    </div>
                `;
            }
            
            clearQuery() {
                this.queryInputEl.value = '';
                this.queryResultsEl.innerHTML = '';
                this.showToast('Query cleared', 'warning');
            }
            
            async getSystemHealth() {
                try {
                    const response = await fetch('https://arabic-rag-system-g7emhxfjaq-uc.a.run.app/health');
                    if (response.ok) {
                        const health = await response.json();
                        this.addMessage('system', 'System Health Check', {
                            status: health.status,
                            vectorStoreReady: health.vector_store_ready,
                            embeddingModelReady: health.embedding_model_ready,
                            generatorReady: health.generator_ready,
                            documentsCount: health.documents_count
                        });
                    }
                } catch (error) {
                    this.addMessage('error', `Health check failed: ${error.message}`);
                }
            }
            
            async getSystemStats() {
                try {
                    const response = await fetch('https://arabic-rag-system-g7emhxfjaq-uc.a.run.app/stats');
                    if (response.ok) {
                        const stats = await response.json();
                        this.addMessage('system', 'System Statistics', {
                            documents: stats.documents,
                            chunks: stats.chunks,
                            vectorStorePath: stats.vector_store_path
                        });
                    }
                } catch (error) {
                    this.addMessage('error', `Stats retrieval failed: ${error.message}`);
                }
            }
            
            // Transcription and AI Response Methods
            
            handleTranscriptMessage(data) {
                // Normalize text
                const text = (data.text || '').trim();
                if (!text) {
                    return;
                }
                
                if (!this.finalSegments) {
                    this.finalSegments = [];
                }
                
                if (data.is_final) {
                    // Push a full sentence if possible; otherwise push as-is
                    const normalized = text.replace(/\s+/g, ' ').trim();
                    if (normalized) {
                        this.finalSegments.push(normalized);
                    }
                    this.currentInterimTranscription = '';
                    this.fullTranscription = this.finalSegments.join(' ');
                    this.updateTranscriptionDisplay();
                    this.transcriptionStatusEl.textContent = 'Final';
                } else {
                    // Live interim preview
                    this.currentInterimTranscription = text;
                    this.updateTranscriptionDisplay();
                    this.transcriptionStatusEl.textContent = 'Interim';
                }
            }
            
            updateTranscriptionDisplay() {
                if (this.fullTranscription === '' && this.currentInterimTranscription === '') {
                    this.transcriptionDisplayEl.innerHTML = `
                        <div class="empty-transcription">
                            <i class="fas fa-microphone-slash"></i>
                            <p>Start recording to see live transcription...</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                // Render final transcript as normal statements (sentence blocks)
                if (this.finalSegments && this.finalSegments.length > 0) {
                    this.fullTranscription = this.finalSegments.join(' ');
                    this.finalSegments.forEach(sentence => {
                        const s = (sentence || '').trim();
                        if (!s) return;
                        html += `
                            <div class="transcription-text final">
                                ${s}
                                <div class="transcription-meta">Final</div>
                            </div>
                        `;
                    });
                } else if (this.fullTranscription.trim()) {
                    html += `
                        <div class="transcription-text final">
                            ${this.fullTranscription.trim()}
                            <div class="transcription-meta">Final</div>
                        </div>
                    `;
                }
                
                // Add current interim transcription
                if (this.currentInterimTranscription.trim()) {
                    html += `
                        <div class="transcription-text interim">
                            ${this.currentInterimTranscription}
                            <div class="transcription-meta">Interim</div>
                        </div>
                    `;
                }
                
                this.transcriptionDisplayEl.innerHTML = html;
                this.scrollToBottom(this.transcriptionDisplayEl);
            }
            
            handleAIResponse(data) {
                this.aiResponse = data.text;
                this.updateAIResponseDisplay(data);
            }
            
            updateAIResponseDisplay(data) {
                this.aiResponseDisplayEl.innerHTML = `
                    <div class="ai-response-text">
                        ${data.text}
                        <div class="ai-response-meta">
                            Processing Time: ${data.processing_time_ms || 'N/A'}ms | 
                            Model: ${data.model_used || 'N/A'} | 
                            Sources: ${data.sources ? data.sources.length : 0}
                        </div>
                    </div>
                `;
                this.scrollToBottom(this.aiResponseDisplayEl);
            }
            
            clearTranscription() {
                this.fullTranscription = '';
                this.currentInterimTranscription = '';
                this.updateTranscriptionDisplay();
                this.transcriptionStatusEl.textContent = 'Ready';
                this.showToast('Transcription cleared', 'warning');
            }
            
            async copyTranscription() {
                const textToCopy = this.fullTranscription.trim() || this.currentInterimTranscription.trim();
                if (!textToCopy) {
                    this.showToast('No transcription to copy', 'warning');
                    return;
                }
                
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    this.showToast('Transcription copied to clipboard', 'success');
                } catch (error) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showToast('Transcription copied to clipboard', 'success');
                }
            }
            
            scrollToBottom(element) {
                element.scrollTop = element.scrollHeight;
            }
            
            // Audio Playback Methods
            
            async handleAudioChunk(data) {
                if (data.audio_data) {
                    try {
                        // Decode base64 audio data
                        const audioData = atob(data.audio_data);
                        const audioBuffer = new Uint8Array(audioData.length);
                        for (let i = 0; i < audioData.length; i++) {
                            audioBuffer[i] = audioData.charCodeAt(i);
                        }
                        
                        // Add to audio queue
                        this.audioQueue.push(audioBuffer);
                        
                        // Update audio status
                        this.audioStatusEl.textContent = `Audio Chunks: ${this.audioQueue.length}`;
                        this.playAudioBtn.disabled = false;
                        
                        // Auto-play if not already playing
                        if (!this.isPlayingAudio && this.audioQueue.length === 1) {
                            await this.playAudio();
                        }
                        
                    } catch (error) {
                        console.error('Error handling audio chunk:', error);
                        this.addMessage('error', `Audio chunk error: ${error.message}`);
                    }
                }
            }
            
            async playAudio() {
                if (this.audioQueue.length === 0) {
                    this.showToast('No audio to play', 'warning');
                    return;
                }
                
                try {
                    this.isPlayingAudio = true;
                    this.playAudioBtn.disabled = true;
                    this.stopAudioBtn.disabled = false;
                    this.audioStatusEl.textContent = 'Playing...';
                    
                    // Initialize audio context if needed
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    // Resume audio context if suspended
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                    
                    // Play all audio chunks in sequence
                    for (let i = 0; i < this.audioQueue.length; i++) {
                        if (!this.isPlayingAudio) break; // Stop if user clicked stop
                        
                        const audioBuffer = this.audioQueue[i];
                        await this.playAudioBuffer(audioBuffer);
                    }
                    
                    // Clear audio queue after playing
                    this.audioQueue = [];
                    this.isPlayingAudio = false;
                    this.playAudioBtn.disabled = false;
                    this.stopAudioBtn.disabled = true;
                    this.audioStatusEl.textContent = 'No Audio';
                    
                } catch (error) {
                    console.error('Error playing audio:', error);
                    this.addMessage('error', `Audio playback error: ${error.message}`);
                    this.isPlayingAudio = false;
                    this.playAudioBtn.disabled = false;
                    this.stopAudioBtn.disabled = true;
                    this.audioStatusEl.textContent = 'Error';
                }
            }
            
            async playAudioBuffer(audioBuffer) {
                return new Promise((resolve, reject) => {
                    try {
                        // Create blob from audio data
                        const blob = new Blob([audioBuffer], { type: 'audio/mpeg' });
                        const audioUrl = URL.createObjectURL(blob);
                        
                        // Create audio element
                        const audio = new Audio(audioUrl);
                        
                        audio.onended = () => {
                            URL.revokeObjectURL(audioUrl);
                            resolve();
                        };
                        
                        audio.onerror = (error) => {
                            URL.revokeObjectURL(audioUrl);
                            reject(error);
                        };
                        
                        // Play audio
                        audio.play().catch(reject);
                        
                    } catch (error) {
                        reject(error);
                    }
                });
            }
            
            stopAudio() {
                this.isPlayingAudio = false;
                this.playAudioBtn.disabled = false;
                this.stopAudioBtn.disabled = true;
                this.audioStatusEl.textContent = `Audio Chunks: ${this.audioQueue.length}`;
                this.showToast('Audio stopped', 'warning');
            }
            
            // Debug Methods
            
            addDebugLog(level, message, details = null) {
                if (!this.debugMode) return;
                
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = {
                    timestamp,
                    level,
                    message,
                    details,
                    id: Date.now() + Math.random()
                };
                
                this.debugLogEntries.push(logEntry);
                
                // Keep only last 100 logs
                if (this.debugLogEntries.length > 100) {
                    this.debugLogEntries = this.debugLogEntries.slice(-100);
                }
                
                this.updateDebugDisplay();
            }
            
            updateDebugDisplay() {
                if (!this.debugMode) return;
                
                const logsContainer = this.debugLogs;
                if (this.debugLogEntries.length === 0) {
                    logsContainer.innerHTML = `
                        <div class="empty-debug">
                            <i class="fas fa-terminal"></i>
                            <p>Debug logs will appear here...</p>
                        </div>
                    `;
                    return;
                }
                
                const logsHtml = this.debugLogEntries.map(log => `
                    <div class="debug-log-entry ${log.level}">
                        <div class="debug-log-timestamp">${log.timestamp}</div>
                        <div class="debug-log-message">${log.message}</div>
                        ${log.details ? `<div class="debug-log-details">${JSON.stringify(log.details, null, 2)}</div>` : ''}
                    </div>
                `).join('');
                
                logsContainer.innerHTML = logsHtml;
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
            
            updateDebugStats() {
                this.connectionStateEl.textContent = this.connectionState;
                this.connectionAttemptsEl.textContent = this.connectionAttempts;
                this.totalMessagesEl.textContent = this.performanceMetrics.totalMessages;
                this.totalErrorsEl.textContent = this.performanceMetrics.errors;
            }
            
            updateConnectionStatus(state) {
                this.connectionState = state;
                this.updateDebugStats();
                
                // Update status element if it exists
                const statusEl = document.getElementById('status');
                if (statusEl) {
                    statusEl.textContent = state.charAt(0).toUpperCase() + state.slice(1);
                    statusEl.className = `status-${state}`;
                }
            }
            
            toggleDebugMode() {
                this.debugMode = !this.debugMode;
                this.debugContent.style.display = this.debugMode ? 'block' : 'none';
                this.toggleDebugBtn.innerHTML = this.debugMode ? 
                    '<i class="fas fa-eye-slash"></i> Hide Debug' : 
                    '<i class="fas fa-eye"></i> Show Debug';
                
                if (this.debugMode) {
                    this.updateDebugDisplay();
                    this.updateDebugStats();
                }
            }
            
            clearDebugLogs() {
                this.debugLogEntries = [];
                this.updateDebugDisplay();
                this.showToast('Debug logs cleared', 'info');
            }
            
            exportDebugLogs() {
                const debugData = {
                    timestamp: new Date().toISOString(),
                    connectionAttempts: this.connectionAttempts,
                    connectionState: this.connectionState,
                    performanceMetrics: this.performanceMetrics,
                    lastError: this.lastError,
                    logs: this.debugLogEntries
                };
                
                const blob = new Blob([JSON.stringify(debugData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `orchestrator-debug-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast('Debug logs exported', 'success');
            }
        }
        
        // Initialize the client
        const client = new ModernOrchestratorClient();
    </script>
</body>
</html>